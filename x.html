<script>
    // Obtener el valor de n de la URL
    var urlParams = new URLSearchParams(window.location.search);
    var n = urlParams.get('n');

    // Verificar si n es válido
    if (n <= 0 || isNaN(n)) {
        alert("Número inválido. Por favor, regrese a la página principal y proporcione un número válido.");
    } else {
        // Crear la tabla original
        var tablaOriginal = "<table>";
        tablaOriginal += "<thead><tr><th>N°</th><th>Producto</th><th>Cantidad</th><th>Precio Unitario</th><th>Ventas Totales</th></tr></thead>";
        tablaOriginal += "<tbody>";

        // Generar filas de la tabla con inputs
        for (var i = 1; i <= n; i++) {
            tablaOriginal += "<tr>";
            tablaOriginal += "<td>" + i + "</td>";
            tablaOriginal += "<td>Producto " + i + "</td>";
            tablaOriginal += "<td><input type='number' id='cantidad" + i + "' min='0' oninput='calcularVentasTotales(" + i + ")'></td>";
            tablaOriginal += "<td><input type='number' id='precio" + i + "' min='0' oninput='calcularVentasTotales(" + i + ")'></td>";
            tablaOriginal += "<td><input type='number' id='ventas" + i + "' min='0' readonly></td>";  // La columna Ventas Totales es de solo lectura
            tablaOriginal += "</tr>";
        }

        tablaOriginal += "</tbody></table>";

        // Mostrar la tabla original en el contenedor
        document.getElementById("tablaContainer").innerHTML = tablaOriginal;
    }

    // Función para calcular las Ventas Totales
    function calcularVentasTotales(index) {
        var cantidad = parseInt(document.getElementById('cantidad' + index).value) || 0;
        var precio = parseFloat(document.getElementById('precio' + index).value) || 0;
        var ventasTotales = cantidad * precio;
        document.getElementById('ventas' + index).value = ventasTotales.toFixed(2);
    }

    // Función para ordenar la tabla por Ventas Totales de mayor a menor
    function ordenarTabla() {
        // Obtener la tabla original
        var tableOriginal = document.querySelector('#tablaContainer table');

        // Clonar la tabla original
        var tableClone = tableOriginal.cloneNode(true);

        // Obtener el tbody de la tabla clonada
        var tbodyClone = tableClone.querySelector('tbody');

        // Obtener todas las filas de la tabla clonada
        var rowsClone = Array.from(tbodyClone.querySelectorAll('tr'));

        // Calcular la sumatoria de Ventas Totales
        var sumatoriaVentas = Array.from(rowsClone).reduce((sum, row) => {
            var ventas = parseFloat(row.querySelector('td:last-child input').value) || 0;
            return sum + ventas;
        }, 0);

        // Ordenar las filas clonadas por Ventas Totales de mayor a menor
        rowsClone.sort((a, b) => {
            var ventasA = parseFloat(a.querySelector('td:last-child input').value);
            var ventasB = parseFloat(b.querySelector('td:last-child input').value);

            return ventasB - ventasA;
        });

        // Limpiar el contenido actual de la tabla clonada
        tbodyClone.innerHTML = "";

        // Agregar las filas ordenadas a la tabla clonada sin las columnas de Cantidad y Precio Unitario
        rowsClone.forEach(row => {
            var newRow = row.cloneNode(true);
            newRow.removeChild(newRow.querySelector('td:nth-child(3)')); // Eliminar la columna de Cantidad
            newRow.removeChild(newRow.querySelector('td:nth-child(3)')); // Eliminar la columna de Precio Unitario
            tbodyClone.appendChild(newRow);
        });

        // Eliminar las cabeceras de Precio Unitario y Cantidad en la tabla clonada
        tableClone.querySelector('thead th:nth-child(3)').remove();
        tableClone.querySelector('thead th:nth-child(3)').remove();

        // Crear una fila para mostrar la sumatoria de Ventas Totales
        var sumatoriaRow = document.createElement('tr');
        var sumatoriaCell = document.createElement('td');
        sumatoriaCell.colSpan = 2; // Ocupa tres columnas
        sumatoriaCell.textContent = 'Sumatoria de Ventas Totales';
        sumatoriaRow.appendChild(sumatoriaCell);

        var sumatoriaVentasCell = document.createElement('td');
        sumatoriaVentasCell.textContent = sumatoriaVentas.toFixed(2);
        sumatoriaRow.appendChild(sumatoriaVentasCell);

        tbodyClone.appendChild(sumatoriaRow);

        // Agregar las nuevas columnas "Acumulado" y "% Acumulado" al encabezado de la tabla clonada
        var acumuladoHeader = document.createElement('th');
        acumuladoHeader.textContent = 'Acumulado';
        tableClone.querySelector('thead tr').appendChild(acumuladoHeader);

        var porcentajeAcumuladoHeader = document.createElement('th');
        porcentajeAcumuladoHeader.textContent = '% Acumulado';
        tableClone.querySelector('thead tr').appendChild(porcentajeAcumuladoHeader);

        // Obtener la columna de Ventas Totales en la tabla clonada
        var ventasTotalesColumn = tableClone.querySelectorAll('td:last-child input');

        // Inicializar acumulado
        var acumulado = 0;

        // Calcular el % acumulado
        var porcentajeAcumulado = 0;

        // Recorrer las filas y agregar datos a las nuevas columnas
        rowsClone.forEach((row, index) => {
            var ventas = parseFloat(row.querySelector('td:last-child input').value) || 0;

            acumulado += ventas;

            // Añadir el acumulado a la columna correspondiente
            var acumuladoCell = document.createElement('td');
            acumuladoCell.textContent = acumulado.toFixed(2);
            row.appendChild(acumuladoCell);

            porcentajeAcumulado = (acumulado / sumatoriaVentas) * 100;

            // Agregar las nuevas columnas a la fila actual
            var porcentajeAcumuladoCell = document.createElement('td');
            porcentajeAcumuladoCell.textContent = porcentajeAcumulado.toFixed(2) + '%';
            row.appendChild(porcentajeAcumuladoCell);
        });

        // Crear un nuevo contenedor para la tabla ordenada
        var newTableContainer = document.createElement('div');
        newTableContainer.appendChild(tableClone);

        // Mostrar la tabla ordenada en el cuerpo del documento
        document.body.appendChild(newTableContainer);
    }
</script>